<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ person.name }}ë‹˜ì˜ í”„ë¡œí•„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Noto Sans KR', sans-serif; } </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto max-w-lg p-4">
        <div id="profile-card" class="w-full bg-white rounded-xl shadow-lg p-8">
            
            <!-- í”„ë¡œí•„ í—¤ë”: ì´ë¯¸ì§€ì™€ ì´ë¦„ -->
            <div class="flex flex-col items-center">
                {% if person.profile_image %}
                    <img src="{{ person.profile_image.url }}" alt="{{ person.name }}ì˜ í”„ë¡œí•„ ì‚¬ì§„" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-md mb-4">
                {% else %}
                    <div class="w-32 h-32 bg-purple-200 rounded-full flex items-center justify-center mb-4 border-4 border-white shadow-md">
                        <span class="text-5xl text-purple-600 font-bold">{{ person.name|first }}</span>
                    </div>
                {% endif %}
                <h1 class="text-3xl font-bold text-gray-800">{{ person.name }}</h1>
                <p class="text-gray-500 mt-1">{{ person.group }} / {{ person.team }}</p>
            </div>

            <!-- ìê¸°ì†Œê°œ -->
            {% if person.bio %}
            <div class="mt-8 text-center">
                <h2 class="text-lg font-semibold text-gray-700">ìê¸°ì†Œê°œ</h2>
                <p class="mt-2 text-gray-600">{{ person.bio|linebreaksbr }}</p>
            </div>
            {% endif %}

            <!-- Fun Fact -->
            {% if person.fun_fact %}
            <div class="mt-8 text-center bg-purple-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold text-purple-700">TMI / Fun Fact! ğŸ¥³</h2>
                <p class="mt-2 text-purple-800">{{ person.fun_fact }}</p>
            </div>
            {% endif %}

            <!-- ë²„íŠ¼ ì»¨í…Œì´ë„ˆ -->
            <div class="mt-8">
                {% if show_claim_button %}
                    <!-- Case 1: ì´ í”„ë¡œí•„ì€ ì£¼ì¸ì´ ì—†ê³ , ë‚´ ë¸Œë¼ìš°ì €ë„ ë“±ë¡ë˜ì§€ ì•ŠìŒ -->
                    <form action="{% url 'profiles:claim_profile' person.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-colors bg-green-600 hover:bg-green-700">
                            ì´ í”„ë¡œí•„ì„ ë‚´ ê²ƒìœ¼ë¡œ ë§Œë“¤ê¸°
                        </button>
                    </form>

                {% elif viewer %}
                    {% if viewer == person %}
                        <!-- Case 2: ë‚´ í”„ë¡œí•„ì„ ë³´ê³  ìˆìŒ -> ìŠ¤ìº” ë²„íŠ¼ê³¼ ìˆ˜ì • ë²„íŠ¼ í‘œì‹œ (ìˆ˜ì •ë¨) -->
                        <button id="start-scan-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-colors bg-purple-600 hover:bg-purple-700">
                            ë‹¤ë¥¸ ì‚¬ëŒ QR ìŠ¤ìº”í•˜ê¸°
                        </button>
                        <a href="{% url 'profiles:profile_edit' person.id %}" class="mt-4 w-full text-center block bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                            âœï¸ ë‚´ í”„ë¡œí•„ ìˆ˜ì •í•˜ê¸°
                        </a>
                    {% else %}
                        <!-- Case 3: ë‹¤ë¥¸ ì‚¬ëŒì˜ í”„ë¡œí•„ì„ ë³´ê³  ìˆìŒ -->
                        <form action="{% url 'profiles:add_scanned_person' person.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-colors bg-blue-600 hover:bg-blue-700">
                                ğŸ‘‹ '{{ person.name }}'ë‹˜ ë§Œë‚¬ìŠµë‹ˆë‹¤! ëª©ë¡ì— ì¶”ê°€
                            </button>
                        </form>
                    {% endif %}
                {% else %}
                     <!-- Case 4: ë‚˜ëŠ” ë“±ë¡ë˜ì§€ ì•Šì•˜ì§€ë§Œ, ì´ë¯¸ ì£¼ì¸ì´ ìˆëŠ” í”„ë¡œí•„ì„ ë´„ -->
                     <div class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">
                        ìì‹ ì˜ QRì½”ë“œë¥¼ ë¨¼ì € ìŠ¤ìº”í•˜ì—¬ í”„ë¡œí•„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.
                     </div>
                {% endif %}
            </div>

            <!-- ë§Œë‚œ ì‚¬ëŒë“¤ ëª©ë¡ -->
            <div class="mt-8">
                <h2 class="text-xl font-bold text-gray-800 text-center mb-4">{{ person.name }}ë‹˜ì´ ë§Œë‚œ ì‚¬ëŒë“¤ ({{ person.scanned_people.count }}ëª…)</h2>
                <div id="scanned-list" class="space-y-2">
                    {% for scanned_person in person.scanned_people.all %}
                        <a href="{% url 'profiles:profile_detail' scanned_person.pk %}" class="bg-gray-100 p-3 rounded-lg flex items-center hover:bg-gray-200">
                            {% if scanned_person.profile_image %}
                                <img src="{{ scanned_person.profile_image.url }}" alt="{{ scanned_person.name }}'s profile picture" class="w-8 h-8 rounded-full object-cover mr-3">
                            {% else %}
                                <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center mr-3"><span class="font-bold text-gray-600">{{ scanned_person.name|first }}</span></div>
                            {% endif %}
                            <span class="text-gray-700">{{ scanned_person.name }}</span>
                        </a>
                    {% empty %}
                        <p id="empty-list-msg" class="text-center text-gray-500">ì•„ì§ ë§Œë‚œ ì‚¬ëŒì´ ì—†ì–´ìš”!</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- ìŠ¤ìºë„ˆ ëª¨ë‹¬ (ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
    <div id="scanner-container" class="fixed inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div id="reader" class="w-full max-w-md bg-white rounded-lg overflow-hidden"></div>
        <button id="close-scan-btn" class="mt-4 bg-white text-black font-bold py-2 px-6 rounded-lg">ë‹«ê¸°</button>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scanButton = document.getElementById('start-scan-btn');
            const scannerContainer = document.getElementById('scanner-container');
            const closeScanBtn = document.getElementById('close-scan-btn');

            // ë‚´ í”„ë¡œí•„ í˜ì´ì§€ì¼ ë•Œë§Œ ìŠ¤ìº” ë²„íŠ¼ì´ ì¡´ì¬í•¨
            if (scanButton) {
                const html5QrCode = new Html5Qrcode("reader");

                scanButton.addEventListener('click', () => {
                    scannerContainer.style.display = 'flex';
                    startScanner();
                });

                closeScanBtn.addEventListener('click', () => {
                    stopScanner();
                });

                function startScanner() {
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        onScanSuccess,
                        (errorMessage) => { /* ìŠ¤ìº” ì‹¤íŒ¨ ì‹œ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨ */ }
                    ).catch(err => {
                        alert("ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    });
                }

                function stopScanner() {
                    html5QrCode.stop().then(ignore => {
                        scannerContainer.style.display = 'none';
                    }).catch(err => {
                        console.error("ìŠ¤ìºë„ˆ ì¤‘ì§€ ì‹¤íŒ¨", err);
                        scannerContainer.style.display = 'none'; // ì‹¤íŒ¨í•´ë„ ì¼ë‹¨ ë‹«ê¸°
                    });
                }

                function onScanSuccess(decodedText, decodedResult) {
                    stopScanner();
                    try {
                        // ìŠ¤ìº”ëœ í…ìŠ¤íŠ¸ê°€ ìœ íš¨í•œ URLì¸ì§€ í™•ì¸
                        new URL(decodedText);
                        // ìœ íš¨í•œ URLì´ë©´ í•´ë‹¹ í˜ì´ì§€ë¡œ ì´ë™
                        window.location.href = decodedText;
                    } catch (error) {
                        alert("ìœ íš¨í•˜ì§€ ì•Šì€ QRì½”ë“œì…ë‹ˆë‹¤. ì´ í–‰ì‚¬ì˜ QRì½”ë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                    }
                }
            }
        });
    </script>
</body>
</html>
