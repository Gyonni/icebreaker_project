{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ person.name }}ë‹˜ì˜ í”„ë¡œí•„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Noto Sans KR', sans-serif; } 
        .emoji-btn {
            background-color: #f3f4f6; color: #374151;
            padding: 0.75rem 1rem; border-radius: 0.5rem;
            font-weight: 600; transition: all 0.2s;
            border: 1px solid #d1d5db;
        }
        .emoji-btn:hover { background-color: #e5e7eb; }
        .emoji-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto max-w-lg p-4">
        <div id="profile-card" class="w-full bg-white rounded-xl shadow-lg p-8">

            <!-- CSRF í† í° (JavaScriptì—ì„œ ì‚¬ìš©) -->
            {% csrf_token %}

            <!-- í”„ë¡œí•„ í—¤ë” -->
            <div class="flex flex-col items-center">
                {% if person.profile_image %}
                    <img src="{{ person.profile_image.url }}" alt="{{ person.name }}ì˜ í”„ë¡œí•„ ì‚¬ì§„" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-md mb-4">
                {% else %}
                    <div class="w-32 h-32 bg-purple-200 rounded-full flex items-center justify-center mb-4 border-4 border-white shadow-md">
                        <span class="text-5xl text-purple-600 font-bold">{{ person.name|first }}</span>
                    </div>
                {% endif %}
                <h1 class="text-3xl font-bold text-gray-800">{{ person.name }}</h1>
                <p class="text-gray-500 mt-1">{{ person.group }} / {{ person.team }}</p>
            </div>

            <!-- ìê¸°ì†Œê°œ -->
            {% if person.bio %}
            <div class="mt-8 text-center">
                <h2 class="text-lg font-semibold text-gray-700">ìê¸°ì†Œê°œ</h2>
                <p class="mt-2 text-gray-600">{{ person.bio|linebreaksbr }}</p>
            </div>
            {% endif %}

            <!-- Fun Fact -->
            {% if person.fun_fact %}
            <div class="mt-8 text-center bg-purple-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold text-purple-700">TMI / Fun Fact! ğŸ¥³</h2>
                <p class="mt-2 text-purple-800">{{ person.fun_fact }}</p>
            </div>
            {% endif %}

            <!-- ë©”ì¸ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ -->
            <div class="mt-8 space-y-4">
                {% if show_claim_button %}
                    <form action="{% url 'profiles:claim_profile' person.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-colors bg-green-600 hover:bg-green-700">ì´ í”„ë¡œí•„ì„ ë‚´ ê²ƒìœ¼ë¡œ ë§Œë“¤ê¸°</button>
                    </form>
                {% elif viewer %}
                    {% if viewer.id == person.id %}
                        <button id="start-scan-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-colors bg-purple-600 hover:bg-purple-700">ë‹¤ë¥¸ ì‚¬ëŒ QR ìŠ¤ìº”í•˜ê¸°</button>
                        <a href="{% url 'profiles:profile_edit' person.id %}" class="w-full text-center block bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors">âœï¸ ë‚´ í”„ë¡œí•„ ìˆ˜ì •í•˜ê¸°</a>
                        <a href="{% url 'profiles:bingo_board' %}" class="w-full text-center block bg-yellow-400 text-gray-900 font-bold py-3 px-4 rounded-lg hover:bg-yellow-300 transition-colors">ğŸ² ë‚˜ì˜ ë¹™ê³ íŒ ë³´ê¸°</a>
                        {% else %}
                        {% if is_already_scanned %}
                            <button disabled class="w-full text-white font-bold py-3 px-4 rounded-lg bg-gray-400 cursor-not-allowed">âœ… ì´ë¯¸ ë§Œë‚œ ì‚¬ëŒì…ë‹ˆë‹¤</button>
                        {% else %}
                            <form action="{% url 'profiles:add_scanned_person' person.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-colors bg-blue-600 hover:bg-blue-700">ğŸ‘‹ '{{ person.name }}'ë‹˜ ë§Œë‚¬ìŠµë‹ˆë‹¤! ëª©ë¡ì— ì¶”ê°€</button>
                            </form>
                        {% endif %}
                    {% endif %}
                {% else %}
                     <div class="text-center text-gray-500 p-4 bg-gray-50 rounded-lg">ìì‹ ì˜ QRì½”ë“œë¥¼ ë¨¼ì € ìŠ¤ìº”í•˜ì—¬ í”„ë¡œí•„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.</div>
                {% endif %}
            </div>

            <!-- 3T1L ê²Œì„ ì„¹ì…˜ -->
            {% if viewer and viewer.id != person.id and sentences %}
            <div class="mt-8 pt-8 border-t border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 text-center mb-4">ğŸ² 3 Truths 1 Lie ê²Œì„</h2>
                <div id="game-container" class="text-center">
                    <button id="show-3t1l-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-colors bg-gray-700 hover:bg-gray-800">ğŸ¤« 3 Truths 1 Lie ë³´ê¸°</button>
                    <div id="sentences-container" class="hidden space-y-3 text-left mt-4">
                        {% for number, sentence in sentences %}
                        <div class="bg-gray-100 p-3 rounded-lg" data-number="{{ number }}">
                            <span class="font-bold text-purple-600 mr-2">{{ number }}.</span>
                            <span>{{ sentence }}</span>
                        </div>
                        {% endfor %}
                        <button id="reveal-answer-btn" class="mt-4 w-full text-white font-bold py-3 px-4 rounded-lg transition-colors bg-red-600 hover:bg-red-700">ğŸ™Œ ëŒ€í™”ë¥¼ ì™„ë£Œí–ˆì–´ìš”!</button>
                    </div>
                    <div id="emoji-container" class="hidden mt-4">
                        {% if has_reacted %}
                            <p class="font-semibold mb-3 text-green-600">ì´ëª¨í‹°ì½˜ ì„ ë¬¼ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                        {% else %}
                            <p class="font-semibold mb-3">ëŒ€í™” í›„ì˜ ê°ìƒì„ ì´ëª¨í‹°ì½˜ìœ¼ë¡œ ì„ ë¬¼í•˜ì„¸ìš”!</p>
                            <div class="grid grid-cols-2 gap-3">
                                <button data-emoji="laughed" class="emoji-btn">ğŸ˜‚ ì™„ì „ ì†ì•˜ë„¤!</button>
                                <button data-emoji="touched" class="emoji-btn">ğŸ˜­ ê°ë™ì ì¸ ì´ì•¼ê¸°</button>
                                <button data-emoji="tmi" class="emoji-btn">ğŸ‘ ìµœê³ ì˜ TMI</button>
                                <button data-emoji="wow" class="emoji-btn">ğŸ¤¯ ëŒ€ë°•ì´ì—ìš”!</button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- [ìˆ˜ì •] ë§Œë‚œ ì‚¬ëŒë“¤ ëª©ë¡ì„ ì ‘ì´ì‹(details/summary)ìœ¼ë¡œ ë³€ê²½ -->
            <div class="mt-8">
                <details class="group">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none bg-gray-50 p-4 rounded-lg hover:bg-gray-100">
                        <h2 class="text-xl font-bold text-gray-800">
                            {{ person.name }}ë‹˜ì´ ë§Œë‚œ ì‚¬ëŒë“¤ ({{ person.scanned_people.count }}ëª…)
                        </h2>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                        </span>
                    </summary>
                    <div id="scanned-list" class="mt-4 space-y-2">
                        {% for scanned_person in person.scanned_people.all %}
                            <a href="{% url 'profiles:profile_detail' scanned_person.pk %}" class="bg-gray-100 p-3 rounded-lg flex items-center hover:bg-gray-200">
                                {% if scanned_person.profile_image %}
                                    <img src="{{ scanned_person.profile_image.url }}" alt="{{ scanned_person.name }}'s profile picture" class="w-8 h-8 rounded-full object-cover mr-3">
                                {% else %}
                                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center mr-3"><span class="font-bold text-gray-600">{{ scanned_person.name|first }}</span></div>
                                {% endif %}
                                <span class="text-gray-700">{{ scanned_person.name }}</span>
                            </a>
                        {% empty %}
                            <p id="empty-list-msg" class="text-center text-gray-500">ì•„ì§ ë§Œë‚œ ì‚¬ëŒì´ ì—†ì–´ìš”!</p>
                        {% endfor %}
                    </div>
                </details>
            </div>
        </div>
    </div>


    <!-- ìŠ¤ìºë„ˆ ëª¨ë‹¬ -->
    <div id="scanner-container" class="fixed inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div id="reader" class="w-full max-w-md bg-white rounded-lg overflow-hidden"></div>
        <button id="close-scan-btn" class="mt-4 bg-white text-black font-bold py-2 px-6 rounded-lg">ë‹«ê¸°</button>
    </div>

    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const scanButton = document.getElementById('start-scan-btn');
        if (scanButton) {
            const scannerContainer = document.getElementById('scanner-container');
            const closeScanBtn = document.getElementById('close-scan-btn');
            const html5QrCode = new Html5Qrcode("reader");
            scanButton.addEventListener('click', () => {
                scannerContainer.style.display = 'flex';
                startScanner();
            });
            closeScanBtn.addEventListener('click', () => stopScanner());
            function startScanner() {
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, () => {})
                    .catch(err => alert("ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”."));
            }
            function stopScanner() {
                html5QrCode.stop().then(() => scannerContainer.style.display = 'none')
                    .catch(err => {
                        console.error("ìŠ¤ìºë„ˆ ì¤‘ì§€ ì‹¤íŒ¨", err);
                        scannerContainer.style.display = 'none';
                    });
            }
            function onScanSuccess(decodedText, decodedResult) {
                stopScanner();
                try {
                    new URL(decodedText);
                    window.location.href = decodedText;
                } catch (error) {
                    alert("ìœ íš¨í•˜ì§€ ì•Šì€ QRì½”ë“œì…ë‹ˆë‹¤. ì´ í–‰ì‚¬ì˜ QRì½”ë“œë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                }
            }
        }

        const gameContainer = document.getElementById('game-container');
        if (gameContainer) {
            const showBtn = document.getElementById('show-3t1l-btn');
            const sentencesContainer = document.getElementById('sentences-container');
            const revealBtn = document.getElementById('reveal-answer-btn');
            const emojiContainer = document.getElementById('emoji-container');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            showBtn.addEventListener('click', () => {
                showBtn.style.display = 'none';
                sentencesContainer.style.display = 'block';
            });

            revealBtn.addEventListener('click', async () => {
                const formData = new FormData();
                formData.append('action', 'reveal_answer');

                const response = await fetch("{% url 'profiles:play_3t1l' person.id %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                    body: formData
                });
                const data = await response.json();

                if (data.status === 'success') {
                    document.querySelectorAll('[data-number]').forEach(el => {
                        if (parseInt(el.dataset.number) === data.lie_answer_number) {
                            el.classList.add('bg-red-200', 'text-red-800');
                        }
                    });
                    revealBtn.style.display = 'none';
                    emojiContainer.style.display = 'block';
                } else {
                    alert(data.message);
                }
            });

            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    btn.disabled = true;
                    const emojiType = btn.dataset.emoji;
                    const formData = new FormData();
                    formData.append('action', 'send_emoji');
                    formData.append('emoji_type', emojiType);

                    const response = await fetch("{% url 'profiles:play_3t1l' person.id %}", {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken },
                        body: formData
                    });
                    const data = await response.json();
                    
                    alert(data.message);
                    document.querySelectorAll('.emoji-btn').forEach(b => b.disabled = true);
                    btn.classList.add('ring-4', 'ring-yellow-400');
                });
            });
        }

        {% if messages %}
            let message_data = [];
            {% for message in messages %}
                message_data.push("{{ message }}");
            {% endfor %}
            if (message_data.length > 0) {
                alert(message_data.join("\n"));
            }
        {% endif %}
    });
    </script>
</body>
</html>
