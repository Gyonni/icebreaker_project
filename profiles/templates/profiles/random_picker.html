{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬íšŒììš© ëœë¤ ë½‘ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Noto Sans KR', sans-serif; } 
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">
    <header class="w-full text-center p-4 bg-white shadow-md z-10">
        <h1 class="text-2xl font-bold text-purple-700">ì‚¬íšŒììš© ëœë¤ ë½‘ê¸°</h1>
    </header>

    <main class="flex-grow flex items-center justify-center p-4 overflow-auto">
        <div id="profile-display" class="w-full max-w-md bg-white text-gray-800 rounded-xl shadow-lg p-8 transition-opacity duration-500 opacity-0 min-h-[500px] flex flex-col items-center justify-center">
            <p class="text-gray-500">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ë²ˆì§¸ ì°¸ê°€ìë¥¼ ë½‘ì•„ì£¼ì„¸ìš”.</p>
        </div>
    </main>

    <footer class="w-full p-4 bg-white/80 backdrop-blur-sm shadow-inner z-10">
        <div class="flex space-x-4 max-w-md mx-auto">
            <button id="draw-btn" class="flex-grow bg-yellow-400 text-gray-900 font-bold text-xl py-4 px-8 rounded-lg shadow-lg hover:bg-yellow-300 transition-transform duration-200 hover:scale-105">
                ë‹¤ìŒ ì‚¬ëŒ ë½‘ê¸°!
            </button>
            <button id="reset-btn" class="bg-red-600 text-white font-bold text-lg py-4 px-6 rounded-lg shadow-lg hover:bg-red-500 transition-colors">
                ì´ˆê¸°í™”
            </button>
        </div>
    </footer>

    <script>
        const display = document.getElementById('profile-display');
        const drawBtn = document.getElementById('draw-btn');
        const resetBtn = document.getElementById('reset-btn');
        const csrfToken = "{{ csrf_token }}"; 

        async function drawNextPerson() {
            display.classList.add('opacity-0');
            drawBtn.disabled = true;
            drawBtn.textContent = 'ë½‘ëŠ” ì¤‘...';

            try {
                const response = await fetch("{% url 'profiles:get_random_profile_data' %}");
                const person = await response.json();

                if (person.status === 'finished') {
                    display.innerHTML = `<h1 class="text-3xl font-bold text-green-600">${person.message}</h1>`;
                    drawBtn.style.display = 'none';
                } else {
                    // [í•µì‹¬ ìˆ˜ì •] ìƒˆë¡œìš´ ë¬¸ë‹µ í•„ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ìê¸°ì†Œê°œ HTMLì„ ìƒì„±í•©ë‹ˆë‹¤.
                    let bioHtml = `
                        <div class="mt-6 w-full text-left space-y-3 text-gray-600">
                            <p>ğŸµ ìš”ì¦˜ ê°€ì¥ ì¦ê²¨ë“£ëŠ” ì°¬ì–‘ì€ <b class="text-purple-600">${person.bio_q1_answer || '(ë¹„ì–´ìˆìŒ)'}</b> ì…ë‹ˆë‹¤.</p>
                            <p>ğŸ¤” ì €ì˜ MBTIëŠ” <b class="text-purple-600">${person.bio_q2_answer || '(ë¹„ì–´ìˆìŒ)'}</b> ì…ë‹ˆë‹¤.</p>
                            <p>ğŸ™ ì´ë²ˆ ìˆ˜ë ¨íšŒì—ì„œ <b class="text-purple-600">${person.bio_q3_answer || '(ë¹„ì–´ìˆìŒ)'}</b> ì€í˜œë¥¼ ë°›ê³  ì‹¶ì–´ìš”.</p>
                        </div>`;

                    let prayerHtml = person.prayer_request ? `
                        <div class="mt-4 pt-4 border-t w-full text-left">
                            <p class="font-semibold text-gray-800">ğŸ™Œ ì €ë¥¼ ìœ„í•´ ê¸°ë„í•´ì£¼ì„¸ìš”!</p>
                            <p class="mt-1 text-gray-600">${person.prayer_request.replace(/\n/g, '<br>')}</p>
                        </div>` : '';

                    let funFactHtml = person.fun_fact ? `<div class="mt-6 w-full text-left bg-purple-50 p-4 rounded-lg"><h2 class="text-lg font-semibold text-purple-700">TMI / Fun Fact! ğŸ¥³</h2><p class="mt-2 text-purple-800">${person.fun_fact}</p></div>` : '';

                    display.innerHTML = `
                        <div class="flex flex-col items-center w-full">
                            <img src="${person.profile_image_url || 'https://placehold.co/150x150/EFEFEF/AAAAAA?text=No+Image'}" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-md mb-4">
                            <h1 class="text-4xl font-bold">${person.name}</h1>
                            <p class="text-gray-500 mt-1 text-lg">${person.group} / ${person.team}</p>
                            ${bioHtml}
                            ${prayerHtml}
                            ${funFactHtml}
                        </div>
                    `;
                }
                display.classList.remove('opacity-0');
            } catch (error) {
                display.innerHTML = '<p class="text-red-500">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
                display.classList.remove('opacity-0');
            } finally {
                drawBtn.disabled = false;
                drawBtn.textContent = 'ë‹¤ìŒ ì‚¬ëŒ ë½‘ê¸°!';
            }
        }

        async function resetPicks() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ì°¸ê°€ìì˜ ë½‘ê¸° ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            try {
                const response = await fetch("{% url 'profiles:reset_all_picks' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                });
                const result = await response.json();
                alert(result.message);
                drawBtn.style.display = 'inline-block';
                display.innerHTML = '<p class="text-gray-500">ì´ˆê¸°í™” ì™„ë£Œ! ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.</p>';
                display.classList.remove('opacity-0');
            } catch (error) {
                alert('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        drawBtn.addEventListener('click', drawNextPerson);
        resetBtn.addEventListener('click', resetPicks);
    </script>
</body>
</html>
